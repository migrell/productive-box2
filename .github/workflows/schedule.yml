name: Update Productivity Gist with Commit Activity
on:
  push:
    branches:
      - master
  schedule:
    - cron: "0 */6 * * *"  # 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (í•˜ë£¨ì— 4ë²ˆ)

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          
      - name: Create update script
        run: |
          cat > update-gist.js << 'EOL'
          const { Octokit } = require('@octokit/rest');
          
          async function main() {
            const octokit = new Octokit({
              auth: process.env.GH_TOKEN
            });
            
            // í•œêµ­ ì‹œê°„ìœ¼ë¡œ ì„¤ì •
            const koreaTime = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
            const hour = koreaTime.getHours();
            
            // ìµœê·¼ 100ê°œì˜ ì´ë²¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            const username = 'migrell'; // GitHub ì‚¬ìš©ì ì´ë¦„
            
            const events = await octokit.activity.listPublicEventsForUser({
              username: username,
              per_page: 100
            });
            
            // ì‹œê°„ëŒ€ë³„ í™œë™ íšŸìˆ˜ ì´ˆê¸°í™”
            const hourActivity = Array(24).fill(0);
            
            // ì´ë²¤íŠ¸ ë¶„ì„
            events.data.forEach(event => {
              const eventDate = new Date(event.created_at);
              const eventHour = new Date(eventDate.toLocaleString('en-US', { timeZone: 'Asia/Seoul' })).getHours();
              hourActivity[eventHour]++;
            });
            
            // ì‹œê°„ëŒ€ë³„ ì´ëª¨ì§€ ë§¤í•‘
            const hourEmojis = hourActivity.map(count => {
              if (count === 0) return 'ğŸŒ™'; // í™œë™ ì—†ìŒ
              if (count < 2) return 'ğŸŒ¤ï¸'; // ì•½ê°„ì˜ í™œë™
              if (count < 5) return 'âš¡'; // ì¤‘ê°„ í™œë™
              return 'ğŸ”¥'; // ë†’ì€ í™œë™
            });
            
            // í˜„ì¬ ì‹œê°„ í‘œì‹œ ê°•ì¡°
            const originalEmoji = hourEmojis[hour];
            hourEmojis[hour] = `[${originalEmoji}]`;
            
            // í™œë™ ìš”ì•½ í†µê³„
            const totalActivity = hourActivity.reduce((sum, count) => sum + count, 0);
            const morningActivity = hourActivity.slice(5, 12).reduce((sum, count) => sum + count, 0);
            const afternoonActivity = hourActivity.slice(12, 18).reduce((sum, count) => sum + count, 0);
            const eveningActivity = hourActivity.slice(18, 24).reduce((sum, count) => sum + count, 0);
            const nightActivity = hourActivity.slice(0, 5).reduce((sum, count) => sum + count, 0);
            
            // ê°€ì¥ í™œë™ì ì¸ ì‹œê°„ëŒ€ ì°¾ê¸°
            let mostActiveHour = 0;
            for (let i = 1; i < 24; i++) {
              if (hourActivity[i] > hourActivity[mostActiveHour]) {
                mostActiveHour = i;
              }
            }
            
            // Gist ë‚´ìš© ë§Œë“¤ê¸°
            let content = '## Jiho\'s Productivity Box\n\n';
            content += '```text\n';
            
            // ì‹œê°„ëŒ€ë³„ ìƒíƒœ í‘œì‹œ
            for (let i = 0; i < 24; i++) {
              const displayHour = i.toString().padStart(2, '0');
              const activityCount = hourActivity[i].toString().padStart(2, ' ');
              content += `${displayHour}:00 ${hourEmojis[i]} ${activityCount}\n`;
            }
            
            content += '```\n\n';
            
            // í™œë™ ìš”ì•½
            content += '### í™œë™ ìš”ì•½\n';
            content += `- ì´ í™œë™: ${totalActivity}íšŒ\n`;
            content += `- ì•„ì¹¨ í™œë™ (05-12): ${morningActivity}íšŒ\n`;
            content += `- ì˜¤í›„ í™œë™ (12-18): ${afternoonActivity}íšŒ\n`;
            content += `- ì €ë… í™œë™ (18-24): ${eveningActivity}íšŒ\n`;
            content += `- ë°¤ í™œë™ (00-05): ${nightActivity}íšŒ\n`;
            content += `- ê°€ì¥ í™œë™ì ì¸ ì‹œê°„: ${mostActiveHour.toString().padStart(2, '0')}:00 (${hourActivity[mostActiveHour]}íšŒ)\n\n`;
            
            content += `Last Updated: ${koreaTime.toLocaleString('ko-KR')}`;
            
            // Gist ì—…ë°ì´íŠ¸
            await octokit.gists.update({
              gist_id: process.env.GIST_ID,
              files: {
                'productive-box.md': {
                  content: content
                }
              }
            });
            
            console.log('Gist updated successfully!');
          }
          
          main().catch(error => {
            console.error('Error updating gist:', error);
            process.exit(1);
          });
          EOL
      
      - name: Install dependencies
        run: npm install @octokit/rest
        
      - name: Update Gist
        run: node update-gist.js
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GIST_ID: 1a12be02f9e72a4ccf2596cba9e1190c
